# Часто задаваемые вопросы (FAQ)

## Общие вопросы

### Что такое PsyBooking Bot?

PsyBooking Bot - это Telegram бот для автоматизации записи клиентов на консультации к психологу. Бот интегрируется с Google Calendar и автоматически создает события при записи.

### Какие основные возможности бота?

- Просмотр доступных дат и времени для записи
- Запись на консультацию через интерактивный интерфейс
- Автоматическое создание событий в Google Calendar
- Защита от двойного бронирования
- Настраиваемое расписание работы
- Rate limiting для защиты от спама

### Нужен ли мне сервер для запуска бота?

Для тестирования можно запустить бота на локальном компьютере. Для продакшн использования рекомендуется VPS или облачный сервер.

## Установка и настройка

### Как получить Telegram Bot Token?

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям (введите имя и username бота)
4. Скопируйте полученный токен

### Как настроить Google Calendar API?

Подробная инструкция в файле `DEPLOYMENT.md`, раздел "Настройка Google Calendar API".

Краткая версия:
1. Создайте проект в Google Cloud Console
2. Включите Google Calendar API
3. Создайте OAuth 2.0 credentials (Desktop app)
4. Скачайте JSON и сохраните как `credentials.json`

### Где хранятся данные?

Все данные хранятся локально в SQLite базе данных в файле `data/psybooking.db`. Google OAuth токен хранится в `data/token.pickle`.

### Как узнать свой Telegram ID?

Напишите боту [@userinfobot](https://t.me/userinfobot) - он покажет ваш ID.

## Использование

### Как изменить рабочие часы?

```bash
# Просмотр текущих настроек
python3 manage.py working-hours show

# Изменение для конкретного дня (0=Вс, 1=Пн, ..., 6=Сб)
python3 manage.py working-hours set 1 09:00 18:00
```

### Как отменить запись клиента?

```bash
# Просмотр всех записей
python3 manage.py bookings show

# Отмена записи по ID
python3 manage.py bookings cancel <ID>
```

### Можно ли изменить длительность консультации?

Да, в файле `config.py` измените параметр `SESSION_DURATION_MINUTES`:

```python
SESSION_DURATION_MINUTES = 60  # Измените на нужное значение
```

### Как изменить часовой пояс?

В файле `config.py` измените параметр `PRIMARY_TZ`:

```python
PRIMARY_TZ = 'Europe/Moscow'  # Или другой часовой пояс
```

Список часовых поясов: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones

### Сколько записей может сделать один пользователь?

По умолчанию - 3 активных записи. Можно изменить в `config.py`:

```python
MAX_ACTIVE_BOOKINGS_PER_USER = 5  # Измените на нужное значение
```

### Как работает защита от спама?

Бот ограничивает количество запросов от одного пользователя до 10 в минуту. Настраивается в `config.py`:

```python
RATE_LIMIT_REQUESTS_PER_MINUTE = 10
```

## Проблемы и решения

### Бот не отвечает на сообщения

**Возможные причины:**

1. **Бот не запущен**
   ```bash
   # Проверить статус (если используется systemd)
   sudo systemctl status psybooking-bot
   
   # Запустить
   sudo systemctl start psybooking-bot
   ```

2. **Неверный токен**
   - Проверьте `.env` файл
   - Убедитесь, что токен скопирован полностью
   - Попробуйте создать нового бота

3. **Ошибка в коде**
   ```bash
   # Проверить логи
   sudo journalctl -u psybooking-bot -n 50
   ```

### Ошибка "Google Calendar API not enabled"

**Решение:**
1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Выберите ваш проект
3. APIs & Services → Library
4. Найдите "Google Calendar API"
5. Нажмите "Enable"

### Ошибка "credentials.json not found"

**Решение:**
1. Убедитесь, что файл `credentials.json` находится в корне проекта
2. Проверьте права доступа к файлу:
   ```bash
   ls -la credentials.json
   chmod 600 credentials.json
   ```

### Ошибка "Token has been expired or revoked"

**Решение:**
```bash
# Удалить старый токен
rm data/token.pickle

# Запустить бота - откроется окно авторизации
python3 bot.py
```

### Слоты не отображаются

**Возможные причины:**

1. **Рабочие часы не настроены или выключены**
   ```bash
   python3 manage.py working-hours show
   ```

2. **Слишком большое значение MIN_HOURS_BEFORE_BOOKING**
   - Проверьте `config.py`
   - Уменьшите значение если нужно

3. **Все слоты заняты в Google Calendar**
   - Проверьте календарь на наличие событий
   - Убедитесь, что используется правильный календарь

### Двойное бронирование

**Защита:**
- База данных имеет уникальный индекс на `start_time_utc`
- Перед созданием записи проверяется доступность слота
- При конфликте пользователь получает сообщение "Слот уже занят"

**Если все же произошло:**
1. Проверьте логи бота
2. Проверьте синхронизацию с Google Calendar
3. Вручную отмените одну из записей

### Бот создает события не в том часовом поясе

**Решение:**
1. Проверьте настройку `PRIMARY_TZ` в `config.py`
2. Убедитесь, что используется правильный часовой пояс
3. Перезапустите бота после изменений

### База данных повреждена

**Решение:**
```bash
# Восстановить из бэкапа
cp data/psybooking.db data/psybooking.db.corrupted
cp /path/to/backup/psybooking.db.YYYYMMDD data/psybooking.db

# Перезапустить бота
sudo systemctl restart psybooking-bot
```

## Безопасность

### Безопасно ли хранить токены в .env файле?

Да, если:
- Файл `.env` не коммитится в git (добавлен в `.gitignore`)
- Права доступа установлены правильно: `chmod 600 .env`
- Сервер защищен файрволом и регулярно обновляется

### Как защитить бота от несанкционированного доступа?

1. **Используйте webhook с секретным токеном** (для продакшна)
2. **Настройте файрвол** на сервере
3. **Регулярно обновляйте** систему и зависимости
4. **Используйте HTTPS** для webhook
5. **Ограничьте доступ к БД** правами файловой системы

### Видят ли клиенты данные других клиентов?

Нет, каждый клиент видит только свои записи. Команда `/mybookings` показывает только записи текущего пользователя.

## Продвинутое использование

### Можно ли использовать несколько календарей?

Да, но требуется модификация кода. По умолчанию используется один календарь, указанный в `GOOGLE_CALENDAR_ID`.

### Можно ли добавить оплату за консультации?

Да, можно интегрировать платежные системы (Stripe, ЮKassa и др.). Потребуется модификация бота для добавления платежного flow.

### Можно ли использовать PostgreSQL вместо SQLite?

Да, но потребуется:
1. Изменить код в `database.py` для работы с PostgreSQL
2. Установить `psycopg2` или `asyncpg`
3. Настроить подключение к PostgreSQL

### Можно ли добавить веб-интерфейс?

Да, можно создать веб-панель используя Flask/FastAPI для:
- Управления расписанием
- Просмотра записей
- Настройки интеграций

Это описано в исходном PRD документе.

### Как масштабировать бота для большого количества пользователей?

1. **Переход на PostgreSQL** для лучшей производительности
2. **Использование Redis** для кэширования
3. **Webhook вместо polling** для меньшей нагрузки
4. **Horizontal scaling** - несколько инстансов бота
5. **Мониторинг** с Prometheus + Grafana

## Обслуживание

### Как часто нужно делать бэкап?

Рекомендуется:
- **Ежедневный автоматический бэкап** БД
- **Еженедельный бэкап** всей конфигурации
- Хранить бэкапы минимум **30 дней**

### Как обновить бота?

```bash
# Остановить бота
sudo systemctl stop psybooking-bot

# Обновить код
cd ~/psybooking-bot
git pull

# Обновить зависимости
source venv/bin/activate
pip install -r requirements.txt

# Запустить бота
sudo systemctl start psybooking-bot

# Проверить статус
sudo systemctl status psybooking-bot
```

### Как посмотреть логи?

```bash
# Последние 50 строк
sudo journalctl -u psybooking-bot -n 50

# Следить за логами в реальном времени
sudo journalctl -u psybooking-bot -f

# Логи за сегодня
sudo journalctl -u psybooking-bot --since today
```

### Как очистить старые записи?

```bash
# Подключиться к БД
sqlite3 data/psybooking.db

# Удалить записи старше 30 дней
DELETE FROM bookings 
WHERE start_time_utc < datetime('now', '-30 days');

# Выйти
.quit
```

## Разработка

### Как добавить новую команду в бота?

1. Создайте функцию-обработчик в `bot.py`:
   ```python
   async def my_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
       await update.message.reply_text("Привет!")
   ```

2. Зарегистрируйте обработчик в `main()`:
   ```python
   application.add_handler(CommandHandler('mycommand', my_command))
   ```

3. Добавьте команду в @BotFather через `/setcommands`

### Как изменить текст сообщений?

Все тексты сообщений находятся в `bot.py`. Найдите нужное сообщение и измените текст.

### Как добавить поддержку других языков?

Потребуется:
1. Создать файлы переводов (например, используя `gettext`)
2. Определять язык пользователя (из Telegram)
3. Использовать переводы в сообщениях

### Где найти документацию по python-telegram-bot?

Официальная документация: https://docs.python-telegram-bot.org/

## Поддержка

### Где получить помощь?

1. Изучите документацию в репозитории
2. Проверьте раздел Troubleshooting в `DEPLOYMENT.md`
3. Посмотрите примеры в `EXAMPLES.md`
4. Проверьте логи бота на наличие ошибок

### Как сообщить об ошибке?

Создайте issue в репозитории с описанием:
- Что вы делали
- Что ожидали
- Что произошло на самом деле
- Логи ошибки (если есть)
- Версия Python и ОС

### Можно ли использовать бота коммерчески?

Да, проект распространяется под лицензией MIT, которая позволяет коммерческое использование.
